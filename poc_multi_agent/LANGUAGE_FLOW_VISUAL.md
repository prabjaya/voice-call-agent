# Language Selection - Visual Flow

## ğŸ¯ Complete Visual Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 1: CALL CONNECTS                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Twilio                  FastAPI Server              Session
        â”‚                           â”‚                       â”‚
        â”‚  POST /voice              â”‚                       â”‚
        â”‚  CallSid=CAxxxx           â”‚                       â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
        â”‚                           â”‚                       â”‚
        â”‚                           â”‚  Initialize Session   â”‚
        â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
        â”‚                           â”‚  {                    â”‚
        â”‚                           â”‚    stage: "language_  â”‚
        â”‚                           â”‚           selection"  â”‚
        â”‚                           â”‚    language: null     â”‚
        â”‚                           â”‚  }                    â”‚
        â”‚                           â”‚                       â”‚
        â”‚                           â”‚  Get languages from   â”‚
        â”‚                           â”‚  agent_config.py      â”‚
        â”‚                           â”‚  ["English", "Tamil", â”‚
        â”‚                           â”‚   "Malayalam"]        â”‚
        â”‚                           â”‚                       â”‚
        â”‚  TwiML Response           â”‚                       â”‚
        â”‚  "Select language..."     â”‚                       â”‚
        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
        â”‚                           â”‚                       â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 2: USER SELECTS LANGUAGE                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    User Phone              Twilio                  FastAPI Server
        â”‚                     â”‚                           â”‚
        â”‚  ğŸ—£ï¸ "Tamil"         â”‚                           â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚
        â”‚                     â”‚                           â”‚
        â”‚                     â”‚  Speech-to-Text           â”‚
        â”‚                     â”‚  "Tamil"                  â”‚
        â”‚                     â”‚                           â”‚
        â”‚                     â”‚  POST /process-response   â”‚
        â”‚                     â”‚  SpeechResult="Tamil"     â”‚
        â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
        â”‚                     â”‚                           â”‚
        â”‚                     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                    â”‚ detect_     â”‚
        â”‚                     â”‚                    â”‚ language()  â”‚
        â”‚                     â”‚                    â”‚             â”‚
        â”‚                     â”‚                    â”‚ Input:      â”‚
        â”‚                     â”‚                    â”‚ "Tamil"     â”‚
        â”‚                     â”‚                    â”‚             â”‚
        â”‚                     â”‚                    â”‚ Check:      â”‚
        â”‚                     â”‚                    â”‚ "tamil" in  â”‚
        â”‚                     â”‚                    â”‚ speech?     â”‚
        â”‚                     â”‚                    â”‚ YES!        â”‚
        â”‚                     â”‚                    â”‚             â”‚
        â”‚                     â”‚                    â”‚ Return:     â”‚
        â”‚                     â”‚                    â”‚ "Tamil"     â”‚
        â”‚                     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                           â”‚
        â”‚                     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                    â”‚ Update      â”‚
        â”‚                     â”‚                    â”‚ Session:    â”‚
        â”‚                     â”‚                    â”‚ language=   â”‚
        â”‚                     â”‚                    â”‚ "Tamil"     â”‚
        â”‚                     â”‚                    â”‚ stage=      â”‚
        â”‚                     â”‚                    â”‚ "welcome"   â”‚
        â”‚                     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                           â”‚
        â”‚                     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                    â”‚ Get Welcome â”‚
        â”‚                     â”‚                    â”‚ Message:    â”‚
        â”‚                     â”‚                    â”‚             â”‚
        â”‚                     â”‚                    â”‚ AGENT_      â”‚
        â”‚                     â”‚                    â”‚ METADATA    â”‚
        â”‚                     â”‚                    â”‚ ["LOGISTICSâ”‚
        â”‚                     â”‚                    â”‚ ]["welcome_ â”‚
        â”‚                     â”‚                    â”‚ msg"]       â”‚
        â”‚                     â”‚                    â”‚ ["Tamil"]   â”‚
        â”‚                     â”‚                    â”‚             â”‚
        â”‚                     â”‚                    â”‚ Returns:    â”‚
        â”‚                     â”‚                    â”‚ "à®µà®£à®•à¯à®•à®®à¯..."â”‚
        â”‚                     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                           â”‚
        â”‚                     â”‚  TwiML Response           â”‚
        â”‚                     â”‚  "à®µà®£à®•à¯à®•à®®à¯..."             â”‚
        â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                     â”‚                           â”‚
        â”‚  ğŸ”Š "à®µà®£à®•à¯à®•à®®à¯..."    â”‚                           â”‚
        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 3: LANGUAGE USED THROUGHOUT             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Session Storage         agent_config.py         Voice Generation
        â”‚                           â”‚                       â”‚
        â”‚  language = "Tamil"       â”‚                       â”‚
        â”‚                           â”‚                       â”‚
        â”‚  Get confirmation msg     â”‚                       â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
        â”‚                           â”‚                       â”‚
        â”‚                           â”‚  confirmation_msg:    â”‚
        â”‚                           â”‚  {                    â”‚
        â”‚                           â”‚    "Tamil": "à®¨à®¾à®©à¯..."â”‚
        â”‚                           â”‚  }                    â”‚
        â”‚                           â”‚                       â”‚
        â”‚  "à®¨à®¾à®©à¯ à®šà¯‡à®•à®°à®¿à®¤à¯à®¤..."      â”‚                       â”‚
        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
        â”‚                           â”‚                       â”‚
        â”‚  Generate voice           â”‚                       â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
        â”‚  message="à®¨à®¾à®©à¯..."        â”‚                       â”‚
        â”‚  language="Tamil"         â”‚                       â”‚
        â”‚                           â”‚                       â”‚
        â”‚                           â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚                â”‚ ElevenLabs  â”‚
        â”‚                           â”‚                â”‚ or Twilio   â”‚
        â”‚                           â”‚                â”‚ TTS         â”‚
        â”‚                           â”‚                â”‚             â”‚
        â”‚                           â”‚                â”‚ Language:   â”‚
        â”‚                           â”‚                â”‚ "Tamil"     â”‚
        â”‚                           â”‚                â”‚             â”‚
        â”‚                           â”‚                â”‚ Voice:      â”‚
        â”‚                           â”‚                â”‚ Aditi-      â”‚
        â”‚                           â”‚                â”‚ Neural      â”‚
        â”‚                           â”‚                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                           â”‚                       â”‚
        â”‚  Audio URL                â”‚                       â”‚
        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LANGUAGE DETECTION LOGIC                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Says: "Tamil"
    â†“
speech_lower = "tamil"
    â†“
Check: "tamil" in "tamil"? â†’ YES
    â†“
Return: "Tamil"


User Says: "à®¤à®®à®¿à®´à¯"
    â†“
Check: "à®¤à®®à®¿à®´à¯" in speech? â†’ YES
    â†“
Return: "Tamil"


User Says: "Malayalam"
    â†“
speech_lower = "malayalam"
    â†“
Check: "malayalam" in "malayalam"? â†’ YES
    â†“
Return: "Malayalam"


User Says: "English" or anything else
    â†“
No matches found
    â†“
Return: "English" (default)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MESSAGE RETRIEVAL FLOW                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Need Message
    â†“
Get language from session
language = "Tamil"
    â†“
Get message from agent_config.py
AGENT_METADATA[agent_type][message_type][language]
    â†“
Example:
AGENT_METADATA["LOGISTICS"]["welcome_msg"]["Tamil"]
    â†“
Returns:
"à®µà®£à®•à¯à®•à®®à¯, ERP à®…à®®à¯ˆà®ªà¯à®ªà®¿à®²à®¿à®°à¯à®¨à¯à®¤à¯..."
    â†“
Use message in call


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SESSION STORAGE                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

active_calls[call_sid] = {
    "agent_type": "LOGISTICS",
    "stage": "welcome",
    "language": "Tamil",  â† STORED HERE!
    "system_prompt": "...",
    "history": [
        {"role": "user", "content": "Selected language: Tamil"}
    ],
    "collected_data": {}
}
    â†“
Saved to MongoDB
    â†“
{
    "call_sid": "CAxxxx",
    "agent_type": "LOGISTICS",
    "language": "Tamil",  â† PERSISTED HERE!
    "stage": "welcome",
    ...
}


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LANGUAGE MAPPING                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Language: "Tamil"
    â†“
    â”œâ”€> Twilio Language Code: "ta-IN"
    â”‚   (For speech recognition)
    â”‚
    â”œâ”€> Twilio Voice: "Polly.Aditi-Neural"
    â”‚   (For TTS fallback)
    â”‚
    â””â”€> ElevenLabs: language="Tamil"
        (For natural voice)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPLETE CALL EXAMPLE                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Call Start
    â†“
System: "Please select your language: English, Tamil, Malayalam"
    â†“
User: "Tamil"
    â†“
detect_language("Tamil") â†’ "Tamil"
    â†“
session["language"] = "Tamil"
    â†“
System: "à®µà®£à®•à¯à®•à®®à¯, ERP à®…à®®à¯ˆà®ªà¯à®ªà®¿à®²à®¿à®°à¯à®¨à¯à®¤à¯..."
    â†“
User: "500 à®°à¯‚à®ªà®¾à®¯à¯, 2pm to 5pm"
    â†“
LLM extracts data
    â†“
System: "à®¨à®¾à®©à¯ à®šà¯‡à®•à®°à®¿à®¤à¯à®¤ à®¤à®•à®µà®²à¯: à®•à®Ÿà¯à®Ÿà®£à®®à¯ â‚¹500, à®¨à¯‡à®°à®®à¯ 2pm to 5pm. à®šà®°à®¿à®¯à®¾?"
    â†“
User: "à®†à®®à¯"
    â†“
System: "Thank you! Your information has been updated."
    â†“
Call End

ALL MESSAGES IN TAMIL! âœ…
```

## ğŸ¯ Key Points

1. **Language asked first** - Before any other interaction
2. **Language detected automatically** - From user's speech
3. **Language stored in session** - Used throughout call
4. **All messages from config** - agent_config.py
5. **Voice generated in language** - ElevenLabs or Twilio TTS
6. **Speech recognition configured** - Twilio language code

**Everything automatic after user selects language!** ğŸ‰
